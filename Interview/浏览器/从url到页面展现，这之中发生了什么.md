### 从url到页面展现，这之中发生了什么？

#### 用户输入
用户在地址栏输入关键字，按下回车，浏览器进程会判断是请求url还是搜索内容，此时页面没有变化。
> 按下回车后浏览器进入加载状态，在此之前会触发beforeunload事件。
> 
> 页面要等到提交文档阶段才会被替换内容

#### 1、域名解析

当用户在浏览器中输入url后,你使用的电脑会发出一个DNS请求到本地DNS服务器，DNS请求到达本地DNS服务器之后会有以下几个步骤：

+ 查找浏览器缓存  

  浏览器会检查缓存中有没有这个域名对应的解析过的IP地址，如果缓存中有，这个解析过程就将结束

+ 查找操作系统缓存

  如果用户的浏览器缓存中没有，浏览器会从hosts文件查找是否有存储DNS信息，查找是否有目标域名和对应的IP地址

+ 查找路由器缓存

  如果系统缓存中也找不到，那么查询请求就会发向路由器，路由器一般会有自己的DNS缓存。

+ ISP 的 DNS 服务器

+ 根服务器

  ISP 的 DNS 服务器还找不到的话，它就会向根服务器发出请求，进行递归查询（比如 DNS 服务器先问根域名服务器 -> .com 域名服务器(顶级域名服务器)的 IP 地址，然后再访问.xxx 域名服务器（二级域名服务器），依次类推）

当查找到对应的IP地址之后，通过IP地址查找到对应的服务器，浏览器将用户发起的http请求发送给服务器

#### 2、浏览器向 web 服务器发送一个 HTTP 请求
> 先进行TCP连接, Chrome 最多允许对同一个 Host 建立六个 TCP 连接。不同的浏览器有一些区别
> <br>三次握手建立连接
> <br>如果是https，TCP之后还要建立TLS连接（安全地交换对称密钥）

#### 3、服务器处理请求

#### 4、服务器返回一个 HTTP 响应　
> 根据状态码判断是否需要重定向重新发送url请求，根据Content-Type判断是否为HTML类型，如果是下载类型，那么该请求会提交给浏览器的下载管理器

响应报文由响应行（request line）、响应头部（header）、响应主体三个部分组成。

+ 响应行:

  > 响应行包含协议版本，状态码，状态码描述 ：
  >
  > + 1xx：指示信息--表示请求已接收，继续处理。
  > + 2xx：成功--表示请求已被成功接收、理解、接受。
  > + 3xx：重定向--要完成请求必须进行更进一步的操作。
  > + 4xx：客户端错误--请求有语法错误或请求无法实现。
  > + 5xx：服务器端错误--服务器未能实现合法的请求。

+ 响应头部

  > 响应头部包含响应报文的附加信息，由 名/值 对组成

+ 响应主体

  > 响应主体包含回车符、换行符和响应返回数据，并不是所有响应报文都有响应数据

#### 5、浏览器解析渲染页面
> 首先当 浏览器进程 接收到 网络进程 的响应数据之后，便向 渲染进程 发起“提交文档”的消息；
> <br>渲染进程 接收到“提交文档”的消息后，会 和网络进程建立传输数据的“管道”；
> <br>等文档数据传输完成之后，渲染进程会返回“确认提交”的消息给浏览器进程；
> <br>浏览器进程 在收到“确认提交”的消息后，会更新浏览器界面状态，包括了安全状态、地址栏的 url、前进后退的历史状态，并更新 Web 页面。

- 根据 HTML 解析出 DOM 树

  > 根据 HTML 的内容，将标签按照结构解析成为 DOM 树，DOM 树解析的过程是一个深度优先遍历。即先构建当前节点的所有子节点，再构建下一个兄弟节点。
  >
  > 在读取 HTML 文档，构建 DOM 树的过程中，若遇到 script 标签，则 DOM 树的构建会暂停，直至脚本执行完毕。

- 根据 CSS 解析生成 CSS 规则树

  > 解析 CSS 规则树时 js 执行将暂停，直至 CSS 规则树就绪。
  >
  > 浏览器在 CSS 规则树生成之前不会进行渲染。

- 结合 DOM 树和 CSS 规则树，生成渲染树

  > DOM 树和 CSS 规则树全部准备好了以后，浏览器才会开始构建渲染树。
  >
  > 精简 CSS 并可以加快 CSS 规则树的构建，从而加快页面相应速度。

- 根据渲染树计算每一个节点的信息

  > 布局：通过渲染树中渲染对象的信息，计算出每一个渲染对象的位置和尺寸
  >
  > 回流：在布局完成后，发现了某个部分发生了变化影响了布局，那就需要倒回去重新渲染。

- 根据计算好的信息绘制页面

  > 绘制阶段，系统会遍历呈现树，并调用呈现器的“paint”方法，将呈现器的内容显示在屏幕上。
  >
  > 重绘：某个元素的背景颜色，文字颜色等，不影响元素周围或内部布局的属性，将只会引起浏览器的重绘。
  >
  > 回流：某个元素的尺寸发生了变化，则需重新计算渲染树，重新渲染

